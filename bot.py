import asyncio
import os
import random
from datetime import date
from PIL import Image, ImageDraw, ImageFont

from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–∫–µ–Ω–∞ ---
TOKEN = os.getenv("BOT_TOKEN")

bot = Bot(token=TOKEN)
dp = Dispatcher()

# --- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å ---
user_last_request = {}

# --- –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ ---
keyboard = ReplyKeyboardMarkup(
    keyboard=[[KeyboardButton(text="üîÆ –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ")]],
    resize_keyboard=True
)

# ---------- –¢–ï–ö–°–¢ –ü–†–ï–î–°–ö–ê–ó–ê–ù–ò–ô ----------

PART_1 = [
    "–°–µ–≥–æ–¥–Ω—è", "–°–∫–æ—Ä–æ", "–°–µ–π—á–∞—Å", "–í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è", "–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ",
    "–í —ç—Ç–æ—Ç –¥–µ–Ω—å", "–í–µ—á–µ—Ä–æ–º", "–£—Ç—Ä–æ–º", "–í –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç", "–í –ø–∞—É–∑–µ –º–µ–∂–¥—É –¥–µ–ª–∞–º–∏",
    "–í —Ç–∏—Ö–∏–π —á–∞—Å", "–ö–æ–≥–¥–∞ –º–µ–Ω—å—à–µ –≤—Å–µ–≥–æ –∂–¥–µ—à—å", "–ù–µ–∑–∞–º–µ—Ç–Ω–æ", "–õ–µ–≥–∫–æ", "–ü—Ä–æ—Å—Ç–æ",
    "–° –ª–µ–≥–∫–æ–π —É–ª—ã–±–∫–æ–π", "–°—É–¥—å–±–∞ —à–µ–ø—á–µ—Ç", "–ú–∏—Ä –Ω–∞–º–µ–∫–∞–µ—Ç", "–°–µ–π—á–∞—Å —Å–∞–º–æ–µ –≤—Ä–µ–º—è", "–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Å—è",
    "–í —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç", "–ù–µ —Å–ø–µ—à–∞", "–¢–∏—Ö–æ", "–í–Ω—É—Ç—Ä–∏ —Ç–µ–±—è", "–ù–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ",
    "–°–µ–π—á–∞—Å –∏–ª–∏ –Ω–∏–∫–æ–≥–¥–∞", "–ë–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤", "–ö–∞–∫ –±—É–¥—Ç–æ —Å–ª—É—á–∞–π–Ω–æ", "–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å", "–ù–∞ —É–¥–∏–≤–ª–µ–Ω–∏–µ",
    "–°—É–¥—å–±–∞ –ø–æ–¥–º–∏–≥–Ω—É–ª–∞", "–¢–∏—Ö–æ –∏ —Å–ø–æ–∫–æ–π–Ω–æ", "–° –ª–µ–≥–∫–æ–π –Ω–æ—Ç–∫–æ–π", "–ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ —Å–º–æ—Ç—Ä–∏—Ç", "–ù–∞ –ø–æ—Ä–æ–≥–µ",
    "–í–∑–≥–ª—è–Ω–∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ", "–°–º–æ—Ç—Ä–∏ –ø—Ä—è–º–æ", "–°–µ–≥–æ–¥–Ω—è –º–æ–∂–Ω–æ", "–ù–∞ —Ä–∞–¥–æ—Å—Ç—å", "–°–º–µ–ª–æ",
    "–í —Ç–µ–º–ø–µ –¥–Ω—è", "–°–µ–π—á–∞—Å –≤–∞–∂–Ω–æ", "–ù–µ —Å–ø–µ—à–∞", "–í–Ω—É—Ç—Ä–∏ –º–æ–º–µ–Ω—Ç–∞", "–í–Ω—É—Ç—Ä–∏ —Ç–µ–±—è",
    "–ù–∞ –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–µ", "–° —É–ª—ã–±–∫–æ–π", "–õ–µ–≥–∫–æ –∏ —Å–≤–æ–±–æ–¥–Ω–æ", "–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å", "–í —ç—Ç–æ–º –º–≥–Ω–æ–≤–µ–Ω–∏–∏"
]

PART_2 = [
    "—Ç—ã –Ω–∞–π–¥–µ—à—å —Ç–æ, —á—Ç–æ –∏—Å–∫–∞–ª", "—Ç–µ–±—è –∂–¥–µ—Ç –º–∞–ª–µ–Ω—å–∫–∞—è —Ä–∞–¥–æ—Å—Ç—å", "–Ω–µ –±–æ–π—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏–π",
    "–≤—Å–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω–∞—á–µ", "–ø–æ—è–≤–∏—Ç—Å—è —à–∞–Ω—Å", "–æ—Ç–∫—Ä–æ–µ—Ç—Å—è –Ω–æ–≤–∞—è –¥–æ—Ä–æ–≥–∞",
    "—Å–±—É–¥–µ—Ç—Å—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ", "—Ç—ã —É–¥–∏–≤–∏—à—å—Å—è —Å–µ–±–µ", "—Ç–≤–æ–π —Ö–æ–¥", "—Å–µ–≥–æ–¥–Ω—è –º–æ–∂–Ω–æ –≤—Å—ë",
    "–∫—Ç–æ-—Ç–æ –∑–∞–º–µ—Ç–∏—Ç —Ç–µ–±—è", "—Å–ª—É—á–∏—Ç—Å—è —á—Ç–æ-—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ–µ", "—Ç–≤–æ—è –º—ã—Å–ª—å –≤–∞–∂–Ω–∞",
    "—Ç–µ–±—è –∂–¥–µ—Ç —É–ª—ã–±–∫–∞", "–≤—Å–µ —Å–ª–æ–∂–∏—Ç—Å—è –Ω–µ–æ–±—ã—á–Ω–æ", "–Ω–æ–≤—ã–π –¥–µ–Ω—å –Ω–µ—Å–µ—Ç —à–∞–Ω—Å",
    "–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞", "—Ç–µ–±–µ –±—É–¥–µ—Ç –ª–µ–≥–∫–æ", "—á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è", "–æ—Ç–∫—Ä–æ–µ—Ç—Å—è –¥–≤–µ—Ä—å",
    "—Ç—ã –ø–æ—á—É–≤—Å—Ç–≤—É–µ—à—å —Å–≤–µ—Ç", "–≤–∞–∂–Ω–∞—è –¥–µ—Ç–∞–ª—å –ø—Ä–æ—è–≤–∏—Ç—Å—è", "—Ç–≤–æ–π –≤—ã–±–æ—Ä –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –º–Ω–æ–≥–æ–µ",
    "—Å—É–¥—å–±–∞ —à–µ–ø—á–µ—Ç", "–Ω–µ–æ–±—ã—á–Ω–æ–µ —Å—Ç–∞–Ω–µ—Ç –ø—Ä–∏–≤—ã—á–Ω—ã–º", "—Ç–µ–±—è –∂–¥–µ—Ç –º–∞–ª–µ–Ω—å–∫–æ–µ —á—É–¥–æ",
    "–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏–¥–µ—Ç", "–ø–æ—è–≤–∏—Ç—Å—è –Ω–æ–≤—ã–π –ø—É—Ç—å", "—Ç–≤–æ—è –∏–¥–µ—è –≤–∞–∂–Ω–∞", "–±—É–¥—å –≥–æ—Ç–æ–≤",
    "–≤—Å–µ —Å—Ç–∞–Ω–µ—Ç –ø—Ä–æ—â–µ", "—á—Ç–æ-—Ç–æ —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ–µ —Å–ª—É—á–∏—Ç—Å—è", "—Å–µ–≥–æ–¥–Ω—è –±—É–¥–µ—Ç –¥–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç–∏–π",
    "—Ç–≤–æ–π –º–æ–º–µ–Ω—Ç", "–∂–∏–∑–Ω—å –ø–æ–∫–∞–∂–µ—Ç –∑–Ω–∞–∫", "–Ω–µ–∂–¥–∞–Ω–Ω—ã–π —Å—é—Ä–ø—Ä–∏–∑", "–Ω–æ–≤–∞—è –º—ã—Å–ª—å –ø—Ä–∏–¥–µ—Ç",
    "–≤—Å–µ –º–æ–∂–µ—Ç –ø–æ–≤–µ—Ä–Ω—É—Ç—å—Å—è –∏–Ω–∞—á–µ", "—Ç–≤–æ—è —ç–Ω–µ—Ä–≥–∏—è –≤–∞–∂–Ω–∞", "–æ—Ç–∫—Ä–æ–π –≥–ª–∞–∑–∞ —à–∏—Ä–µ", "–≤–Ω—É—Ç—Ä–∏ —Ç–µ–±—è –Ω–∞–π–¥–µ—Ç—Å—è –æ—Ç–≤–µ—Ç",
    "—á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", "–ø–æ—è–≤–∏—Ç—Å—è –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ", "—Å—É–¥—å–±–∞ —É–ª—ã–±–∞–µ—Ç—Å—è", "—Å–µ–≥–æ–¥–Ω—è –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ",
    "—Ç–≤–æ—è —Å–∏–ª–∞ –≤ –ø—Ä–æ—Å—Ç–æ—Ç–µ", "–Ω–æ–≤—ã–π –≤–∑–≥–ª—è–¥ –ø—Ä–∏–Ω–µ—Å–µ—Ç –ø–æ–ª—å–∑—É", "–∂–¥–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–≥–æ", "–±—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω",
    "—Å–æ–±—ã—Ç–∏–µ –∑–∞—Å—Ç–∞–≤–∏—Ç —É–ª—ã–±–Ω—É—Ç—å—Å—è", "—Ç–≤–æ—è –∏–Ω—Ç—É–∏—Ü–∏—è –ø–æ–¥—Å–∫–∞–∂–µ—Ç", "–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —É—Å–ø–µ—Ö—É"
]

def generate_fortune_text():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ"""
    return f"{random.choice(PART_1)}, {random.choice(PART_2)}."

# ---------- –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–ê–†–¢–ò–ù–ö–ò –° –†–ê–ù–î–û–ú–ù–´–ú –§–û–ù–û–ú ----------

def generate_image(text: str) -> str:
    width, height = 800, 800

    # –°–ª—É—á–∞–π–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
    top_color = tuple(random.randint(200, 255) for _ in range(3))
    bottom_color = tuple(random.randint(180, 230) for _ in range(3))

    image = Image.new("RGB", (width, height), top_color)
    draw = ImageDraw.Draw(image)

    # –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
    for i in range(height):
        ratio = i / height
        r = int(top_color[0] * (1 - ratio) + bottom_color[0] * ratio)
        g = int(top_color[1] * (1 - ratio) + bottom_color[1] * ratio)
        b = int(top_color[2] * (1 - ratio) + bottom_color[2] * ratio)
        draw.line([(0, i), (width, i)], fill=(r, g, b))

    # –õ–æ–∫–∞–ª—å–Ω—ã–π —à—Ä–∏—Ñ—Ç
    font_path = "fonts/Roboto-Regular.ttf"
    font_size = 60
    font = ImageFont.truetype(font_path, font_size)

    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞
    margin = 60
    max_text_width = width - 2 * margin

    # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —à—Ä–∏—Ñ—Ç: —É–º–µ–Ω—å—à–∞–µ–º, –µ—Å–ª–∏ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è
    while True:
        lines = wrap_text(text, font, max_text_width)
        total_text_height = len(lines) * font_size * 1.2
        if total_text_height < height - 2 * margin or font_size <= 20:
            break
        font_size -= 2
        font = ImageFont.truetype(font_path, font_size)

    # –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ
    current_height = (height - total_text_height) // 2

    for line in lines:
        line_width, _ = draw.textsize(line, font=font)
        x = (width - line_width) // 2
        draw.text((x, current_height), line, fill=(30, 30, 60), font=font)
        current_height += int(font_size * 1.2)

    file_path = "fortune.png"
    image.save(file_path)
    return file_path

def wrap_text(text, font, max_width):
    words = text.split()
    lines = []
    current_line = ""
    for word in words:
        test_line = current_line + word + " "
        if font.getlength(test_line) <= max_width:
            current_line = test_line
        else:
            lines.append(current_line.strip())
            current_line = word + " "
    lines.append(current_line.strip())
    return lines

# ---------- –•–ï–ù–î–õ–ï–†–´ ----------

@dp.message(CommandStart())
async def start(message: types.Message):
    await message.answer("üîÆ –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ", reply_markup=keyboard)

@dp.message(lambda m: m.text == "üîÆ –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ")
async def prediction(message: types.Message):
    user_id = message.from_user.id
    username = message.from_user.username
    today = date.today()

    # –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è @evgeny_pashkin
    if username != "evgeny_pashkin":
        last_request = user_last_request.get(user_id)
        if last_request == today:
            await message.answer(
                "–°–µ–≥–æ–¥–Ω—è —Ç—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ. –û–Ω–æ –µ—â—ë –Ω–µ —Å–∫–∞–∑–∞–ª–æ —Å–≤–æ—ë –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ."
            )
            return
        user_last_request[user_id] = today

    text = generate_fortune_text()
    image_path = generate_image(text)
    await message.answer_photo(photo=types.FSInputFile(image_path))

# ---------- MAIN ----------

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())

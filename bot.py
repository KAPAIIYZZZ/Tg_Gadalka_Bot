import asyncio
import os
import random
from datetime import date
from PIL import Image, ImageDraw, ImageFont

from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton

TOKEN = os.getenv("BOT_TOKEN")

bot = Bot(token=TOKEN)
dp = Dispatcher()

user_last_request = {}

keyboard = ReplyKeyboardMarkup(
    keyboard=[[KeyboardButton(text="ðŸ”® ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ")]],
    resize_keyboard=True
)

# ---------- Ð¢Ð•ÐšÐ¡Ð¢ ÐŸÐ Ð•Ð”Ð¡ÐšÐÐ—ÐÐÐ˜Ð™ ----------

PART_1 = [
    "Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ", "Ð¡ÐºÐ¾Ñ€Ð¾", "Ð¡ÐµÐ¹Ñ‡Ð°Ñ", "Ð’ Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐµÐµ Ð²Ñ€ÐµÐ¼Ñ", "ÐÐµÐ¾Ð¶Ð¸Ð´Ð°Ð½Ð½Ð¾", 
    "Ð’ ÑÑ‚Ð¾Ñ‚ Ð´ÐµÐ½ÑŒ", "Ð’ÐµÑ‡ÐµÑ€Ð¾Ð¼", "Ð£Ñ‚Ñ€Ð¾Ð¼", "Ð’ Ð»ÑŽÐ±Ð¾Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚", "Ð’ Ð¿Ð°ÑƒÐ·Ðµ Ð¼ÐµÐ¶Ð´Ñƒ Ð´ÐµÐ»Ð°Ð¼Ð¸",
    "Ð’ Ñ‚Ð¸Ñ…Ð¸Ð¹ Ñ‡Ð°Ñ", "ÐšÐ¾Ð³Ð´Ð° Ð¼ÐµÐ½ÑŒÑˆÐµ Ð²ÑÐµÐ³Ð¾ Ð¶Ð´ÐµÑˆÑŒ", "ÐÐµÐ·Ð°Ð¼ÐµÑ‚Ð½Ð¾", "Ð›ÐµÐ³ÐºÐ¾", "ÐŸÑ€Ð¾ÑÑ‚Ð¾",
    "Ð¡ Ð»ÐµÐ³ÐºÐ¾Ð¹ ÑƒÐ»Ñ‹Ð±ÐºÐ¾Ð¹", "Ð¡ÑƒÐ´ÑŒÐ±Ð° ÑˆÐµÐ¿Ñ‡ÐµÑ‚", "ÐœÐ¸Ñ€ Ð½Ð°Ð¼ÐµÐºÐ°ÐµÑ‚", "Ð¡ÐµÐ¹Ñ‡Ð°Ñ ÑÐ°Ð¼Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ", "ÐŸÑ€Ð¸Ð³Ð¾Ñ‚Ð¾Ð²ÑŒÑÑ",
    "Ð’ ÑÑ‚Ð¾Ñ‚ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚", "ÐÐµ ÑÐ¿ÐµÑˆÐ°", "Ð¢Ð¸Ñ…Ð¾", "Ð’Ð½ÑƒÑ‚Ñ€Ð¸ Ñ‚ÐµÐ±Ñ", "ÐÐ° Ð³Ð¾Ñ€Ð¸Ð·Ð¾Ð½Ñ‚Ðµ",
    "Ð¡ÐµÐ¹Ñ‡Ð°Ñ Ð¸Ð»Ð¸ Ð½Ð¸ÐºÐ¾Ð³Ð´Ð°", "Ð‘ÐµÐ· Ð»Ð¸ÑˆÐ½Ð¸Ñ… ÑÐ»Ð¾Ð²", "ÐšÐ°Ðº Ð±ÑƒÐ´Ñ‚Ð¾ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾", "ÐŸÑ€ÑÐ¼Ð¾ ÑÐµÐ¹Ñ‡Ð°Ñ", "ÐÐ° ÑƒÐ´Ð¸Ð²Ð»ÐµÐ½Ð¸Ðµ",
    "Ð¡ÑƒÐ´ÑŒÐ±Ð° Ð¿Ð¾Ð´Ð¼Ð¸Ð³Ð½ÑƒÐ»Ð°", "Ð¢Ð¸Ñ…Ð¾ Ð¸ ÑÐ¿Ð¾ÐºÐ¾Ð¹Ð½Ð¾", "Ð¡ Ð»ÐµÐ³ÐºÐ¾Ð¹ Ð½Ð¾Ñ‚ÐºÐ¾Ð¹", "ÐŸÐ¾ÐºÐ° Ð½Ð¸ÐºÑ‚Ð¾ Ð½Ðµ ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚", "ÐÐ° Ð¿Ð¾Ñ€Ð¾Ð³Ðµ",
    "Ð’Ð·Ð³Ð»ÑÐ½Ð¸ Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½ÐµÐµ", "Ð¡Ð¼Ð¾Ñ‚Ñ€Ð¸ Ð¿Ñ€ÑÐ¼Ð¾", "Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ð¼Ð¾Ð¶Ð½Ð¾", "ÐÐ° Ñ€Ð°Ð´Ð¾ÑÑ‚ÑŒ", "Ð¡Ð¼ÐµÐ»Ð¾",
    "Ð’ Ñ‚ÐµÐ¼Ð¿Ðµ Ð´Ð½Ñ", "Ð¡ÐµÐ¹Ñ‡Ð°Ñ Ð²Ð°Ð¶Ð½Ð¾", "ÐÐµ ÑÐ¿ÐµÑˆÐ°", "Ð’Ð½ÑƒÑ‚Ñ€Ð¸ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð°", "Ð’Ð½ÑƒÑ‚Ñ€Ð¸ Ñ‚ÐµÐ±Ñ",
    "ÐÐ° Ð¿ÐµÑ€ÐµÐºÑ€ÐµÑÑ‚ÐºÐµ", "Ð¡ ÑƒÐ»Ñ‹Ð±ÐºÐ¾Ð¹", "Ð›ÐµÐ³ÐºÐ¾ Ð¸ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾", "ÐŸÑ€ÑÐ¼Ð¾ ÑÐµÐ¹Ñ‡Ð°Ñ", "Ð’ ÑÑ‚Ð¾Ð¼ Ð¼Ð³Ð½Ð¾Ð²ÐµÐ½Ð¸Ð¸"
]

PART_2 = [
    "Ñ‚Ñ‹ Ð½Ð°Ð¹Ð´ÐµÑˆÑŒ Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ð¸ÑÐºÐ°Ð»", "Ñ‚ÐµÐ±Ñ Ð¶Ð´ÐµÑ‚ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ°Ñ Ñ€Ð°Ð´Ð¾ÑÑ‚ÑŒ", "Ð½Ðµ Ð±Ð¾Ð¹ÑÑ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹",
    "Ð²ÑÐµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¸Ð½Ð°Ñ‡Ðµ", "Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ ÑˆÐ°Ð½Ñ", "Ð¾Ñ‚ÐºÑ€Ð¾ÐµÑ‚ÑÑ Ð½Ð¾Ð²Ð°Ñ Ð´Ð¾Ñ€Ð¾Ð³Ð°",
    "ÑÐ±ÑƒÐ´ÐµÑ‚ÑÑ Ð½ÐµÐ¾Ð¶Ð¸Ð´Ð°Ð½Ð½Ð¾Ðµ", "Ñ‚Ñ‹ ÑƒÐ´Ð¸Ð²Ð¸ÑˆÑŒÑÑ ÑÐµÐ±Ðµ", "Ñ‚Ð²Ð¾Ð¹ Ñ…Ð¾Ð´", "ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð¼Ð¾Ð¶Ð½Ð¾ Ð²ÑÑ‘",
    "ÐºÑ‚Ð¾-Ñ‚Ð¾ Ð·Ð°Ð¼ÐµÑ‚Ð¸Ñ‚ Ñ‚ÐµÐ±Ñ", "ÑÐ»ÑƒÑ‡Ð¸Ñ‚ÑÑ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ ÑÑ‚Ñ€Ð°Ð½Ð½Ð¾Ðµ", "Ñ‚Ð²Ð¾Ñ Ð¼Ñ‹ÑÐ»ÑŒ Ð²Ð°Ð¶Ð½Ð°",
    "Ñ‚ÐµÐ±Ñ Ð¶Ð´ÐµÑ‚ ÑƒÐ»Ñ‹Ð±ÐºÐ°", "Ð²ÑÐµ ÑÐ»Ð¾Ð¶Ð¸Ñ‚ÑÑ Ð½ÐµÐ¾Ð±Ñ‹Ñ‡Ð½Ð¾", "Ð½Ð¾Ð²Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð½ÐµÑÐµÑ‚ ÑˆÐ°Ð½Ñ",
    "Ð½ÐµÐ¾Ð¶Ð¸Ð´Ð°Ð½Ð½Ð°Ñ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð°", "Ñ‚ÐµÐ±Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð»ÐµÐ³ÐºÐ¾", "Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑÑ", "Ð¾Ñ‚ÐºÑ€Ð¾ÐµÑ‚ÑÑ Ð´Ð²ÐµÑ€ÑŒ",
    "Ñ‚Ñ‹ Ð¿Ð¾Ñ‡ÑƒÐ²ÑÑ‚Ð²ÑƒÐµÑˆÑŒ ÑÐ²ÐµÑ‚", "Ð²Ð°Ð¶Ð½Ð°Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒ Ð¿Ñ€Ð¾ÑÐ²Ð¸Ñ‚ÑÑ", "Ñ‚Ð²Ð¾Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ Ð¼Ð½Ð¾Ð³Ð¾Ðµ",
    "ÑÑƒÐ´ÑŒÐ±Ð° ÑˆÐµÐ¿Ñ‡ÐµÑ‚", "Ð½ÐµÐ¾Ð±Ñ‹Ñ‡Ð½Ð¾Ðµ ÑÑ‚Ð°Ð½ÐµÑ‚ Ð¿Ñ€Ð¸Ð²Ñ‹Ñ‡Ð½Ñ‹Ð¼", "Ñ‚ÐµÐ±Ñ Ð¶Ð´ÐµÑ‚ Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¾Ðµ Ñ‡ÑƒÐ´Ð¾",
    "Ð½ÐµÐ¾Ð¶Ð¸Ð´Ð°Ð½Ð½Ð¾Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸Ð´ÐµÑ‚", "Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ", "Ñ‚Ð²Ð¾Ñ Ð¸Ð´ÐµÑ Ð²Ð°Ð¶Ð½Ð°", "Ð±ÑƒÐ´ÑŒ Ð³Ð¾Ñ‚Ð¾Ð²",
    "Ð²ÑÐµ ÑÑ‚Ð°Ð½ÐµÑ‚ Ð¿Ñ€Ð¾Ñ‰Ðµ", "Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ ÑƒÐ´Ð¸Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ ÑÐ»ÑƒÑ‡Ð¸Ñ‚ÑÑ", "ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð±ÑƒÐ´ÐµÑ‚ Ð´ÐµÐ½ÑŒ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ð¹",
    "Ñ‚Ð²Ð¾Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚", "Ð¶Ð¸Ð·Ð½ÑŒ Ð¿Ð¾ÐºÐ°Ð¶ÐµÑ‚ Ð·Ð½Ð°Ðº", "Ð½ÐµÐ¶Ð´Ð°Ð½Ð½Ñ‹Ð¹ ÑÑŽÑ€Ð¿Ñ€Ð¸Ð·", "Ð½Ð¾Ð²Ð°Ñ Ð¼Ñ‹ÑÐ»ÑŒ Ð¿Ñ€Ð¸Ð´ÐµÑ‚",
    "Ð²ÑÐµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒÑÑ Ð¸Ð½Ð°Ñ‡Ðµ", "Ñ‚Ð²Ð¾Ñ ÑÐ½ÐµÑ€Ð³Ð¸Ñ Ð²Ð°Ð¶Ð½Ð°", "Ð¾Ñ‚ÐºÑ€Ð¾Ð¹ Ð³Ð»Ð°Ð·Ð° ÑˆÐ¸Ñ€Ðµ", "Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Ñ‚ÐµÐ±Ñ Ð½Ð°Ð¹Ð´ÐµÑ‚ÑÑ Ð¾Ñ‚Ð²ÐµÑ‚",
    "Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ðµ", "Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑÑ Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²ÐµÐ½Ð¸Ðµ", "ÑÑƒÐ´ÑŒÐ±Ð° ÑƒÐ»Ñ‹Ð±Ð°ÐµÑ‚ÑÑ", "ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð²ÑÐµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾",
    "Ñ‚Ð²Ð¾Ñ ÑÐ¸Ð»Ð° Ð² Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ñ‚Ðµ", "Ð½Ð¾Ð²Ñ‹Ð¹ Ð²Ð·Ð³Ð»ÑÐ´ Ð¿Ñ€Ð¸Ð½ÐµÑÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ñƒ", "Ð¶Ð´Ð¸ Ð½ÐµÐ¾Ð¶Ð¸Ð´Ð°Ð½Ð½Ð¾Ð³Ð¾", "Ð±ÑƒÐ´ÑŒ Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÐµÐ½",
    "ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð·Ð°ÑÑ‚Ð°Ð²Ð¸Ñ‚ ÑƒÐ»Ñ‹Ð±Ð½ÑƒÑ‚ÑŒÑÑ", "Ñ‚Ð²Ð¾Ñ Ð¸Ð½Ñ‚ÑƒÐ¸Ñ†Ð¸Ñ Ð¿Ð¾Ð´ÑÐºÐ°Ð¶ÐµÑ‚", "Ð½ÐµÐ¾Ð¶Ð¸Ð´Ð°Ð½Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð²ÐµÐ´ÐµÑ‚ Ðº ÑƒÑÐ¿ÐµÑ…Ñƒ"
]

def generate_fortune_text():
    return f"{random.choice(PART_1)}, {random.choice(PART_2)}."

# ---------- ÐšÐÐ Ð¢Ð˜ÐÐšÐ ----------

def generate_image(text: str) -> str:
    width, height = 800, 800
    image = Image.new("RGB", (width, height), (250, 245, 230))
    draw = ImageDraw.Draw(image)

    try:
        font = ImageFont.truetype("arial.ttf", 40)
    except:
        font = ImageFont.load_default()

    margin = 60
    current_height = 200

    for line in wrap_text(text, font, width - 2 * margin):
        draw.text((margin, current_height), line, fill=(50, 50, 50), font=font)
        current_height += 60

    file_path = "fortune.png"
    image.save(file_path)
    return file_path

def wrap_text(text, font, max_width):
    words = text.split()
    lines = []
    current_line = ""

    for word in words:
        test_line = current_line + word + " "
        if font.getlength(test_line) <= max_width:
            current_line = test_line
        else:
            lines.append(current_line)
            current_line = word + " "
    lines.append(current_line)
    return lines

# ---------- Ð¥Ð•ÐÐ”Ð›Ð•Ð Ð« ----------

@dp.message(CommandStart())
async def start(message: types.Message):
    await message.answer("ðŸ”® ÐÐ°Ð¶Ð¼Ð¸ ÐºÐ½Ð¾Ð¿ÐºÑƒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ", reply_markup=keyboard)

@dp.message(lambda m: m.text == "ðŸ”® ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ")
async def prediction(message: types.Message):
    user_id = message.from_user.id
    today = date.today()

    if user_last_request.get(user_id) == today:
        await message.answer("Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ñ‚Ñ‹ ÑƒÐ¶Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð» Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ. ÐžÐ½Ð¾ ÐµÑ‰Ñ‘ Ð½Ðµ ÑÐºÐ°Ð·Ð°Ð»Ð¾ ÑÐ²Ð¾Ñ‘ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐµ ÑÐ»Ð¾Ð²Ð¾.")
        return

    user_last_request[user_id] = today

    text = generate_fortune_text()
    image_path = generate_image(text)

    await message.answer_photo(photo=types.FSInputFile(image_path))

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
